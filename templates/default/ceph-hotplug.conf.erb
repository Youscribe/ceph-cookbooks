description "Ceph hotplug"

start on block-device-added \
  DEVTYPE=partition \
  ID_PART_ENTRY_TYPE=4fbd7e29-9d25-41b8-afd0-062c0ceff05d 
stop on runlevel [!2345]

task
instance $DEVNAME

pre-start script
  cephcluster="${ID_FS_LABEL%%-*}"
  cephnode="${ID_FS_LABEL#*-}"
  cephdaemon="${cephnode%%.*}"
  cephid="${cephnode#*.}"

  mkdir -p "/var/lib/ceph/${cephdaemon}/${cephcluster}-${cephid}"
  mount $DEVNAME "/var/lib/ceph/${cephdaemon}/${cephcluster}-${cephid}"
  
end script

script
  cephcluster="${ID_FS_LABEL%%-*}"
  cephnode="${ID_FS_LABEL#*-}"
  cephdaemon="${cephnode%%.*}"
  cephid="${cephnode#*.}" 


  logger "initctl emit ceph-${cephdaemon} cluster=${cephcluster} id=${cephid}"
  exec initctl emit ceph-${cephdaemon} cluster=${cephcluster} id=${cephid}
end script
